name: pypi publish

on:
  push:
    branches: [ master ]
  release:
    types: [ created ]

defaults:
  run:
    shell: bash

jobs:
  deploy:
    name: ${{ matrix.config.name }}
    environment: development
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "ubuntu-22.04"
            os: "ubuntu-latest"
            pyarch: "x64"
          - name: "windows-x64"
            os: "windows-latest"
            arch: "amd64"
            pyarch: "x64"
          - name: "windows-x86"
            os: "windows-latest"
            arch: "i386"
            pyarch: "x86"
    steps:
      - uses: actions/checkout@master
      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
          architecture: ${{ matrix.config.pyarch }}
      - name: Install pypa/build
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      - name: Build package
        run: |
          python -m build --wheel --outdir dist/

      - name: Publish using Twine (Windows)
        if: matrix.config.os == 'windows-latest'
        run: |
          python -m twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

# This fails because I don't have access to `pylsl` project there.
#      - name: Publish distribution ðŸ“¦ to Test PyPI
#        if: (github.event.release.prerelease && (matrix.config.os != 'windows-latest'))
#        uses: pypa/gh-action-pypi-publish@unstable/v1
#        with:
#          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
#          repository_url: https://test.pypi.org/legacy/
#          skip_existing: true
#
      - name: Publish package to TestPyPI
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: twine upload --repository-url https://test.pypi.org/legacy/ dist/*
      - name: Publish package to PyPI
        if: github.event_name == 'release' && github.event.action == 'created'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*
